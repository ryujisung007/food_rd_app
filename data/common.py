"""
ê³µí†µ ë°ì´í„° & ìœ í‹¸ë¦¬í‹°
"""
import pandas as pd
import os, json
from datetime import datetime

# â”â”â” ê²½ë¡œ â”â”â”
_THIS_DIR = os.path.dirname(os.path.abspath(__file__))
_APP_DIR = os.path.dirname(_THIS_DIR)
SAVE_DIR = os.path.join(_APP_DIR, "saved")
os.makedirs(SAVE_DIR, exist_ok=True)

# â”â”â” ìŒë£Œ ë§¤ì¶œ ë°ì´í„° (ë°±ë§Œì›) â”â”â”
SALES_DATA = {
    "ì»¤í”¼ìŒë£Œ": {"2019":2100000,"2020":2250000,"2021":2380000,"2022":2520000,"2023":2680000,"2024":2850000},
    "íƒ„ì‚°ìŒë£Œ": {"2019":1890000,"2020":1920000,"2021":2050000,"2022":2180000,"2023":2350000,"2024":2480000},
    "ìƒìˆ˜":     {"2019":1450000,"2020":1580000,"2021":1720000,"2022":1890000,"2023":2050000,"2024":2200000},
    "ì—ë„ˆì§€ìŒë£Œ":{"2019":380000,"2020":450000,"2021":580000,"2022":720000,"2023":890000,"2024":1050000},
    "ìœ ì‚°ê· ìŒë£Œ":{"2019":680000,"2020":720000,"2021":760000,"2022":800000,"2023":830000,"2024":860000},
    "ê³¼ì±„ìŒë£Œ": {"2019":850000,"2020":830000,"2021":810000,"2022":790000,"2023":770000,"2024":760000},
    "ì°¨ìŒë£Œ":   {"2019":620000,"2020":640000,"2021":680000,"2022":710000,"2023":750000,"2024":790000},
    "ìŠ¤í¬ì¸ ìŒë£Œ":{"2019":520000,"2020":540000,"2021":560000,"2022":590000,"2023":620000,"2024":650000},
    "ë‘ìœ ":     {"2019":420000,"2020":410000,"2021":400000,"2022":395000,"2023":390000,"2024":385000},
    "ì‹í˜œ/ìˆ˜ì •ê³¼":{"2019":180000,"2020":175000,"2021":170000,"2022":168000,"2023":165000,"2024":163000},
}

BRAND_DATA = {
    "íƒ„ì‚°ìŒë£Œ": [
        {"brand":"ì½”ì¹´ì½œë¼","2019":580000,"2020":590000,"2021":620000,"2022":660000,"2023":710000,"2024":750000},
        {"brand":"ì¹ ì„±ì‚¬ì´ë‹¤","2019":410000,"2020":400000,"2021":420000,"2022":430000,"2023":460000,"2024":480000},
        {"brand":"í©ì‹œ","2019":320000,"2020":330000,"2021":360000,"2022":390000,"2023":420000,"2024":450000},
        {"brand":"ìŠ¤í”„ë¼ì´íŠ¸","2019":180000,"2020":190000,"2021":200000,"2022":210000,"2023":230000,"2024":250000},
        {"brand":"ë°€í‚¤ìŠ¤","2019":150000,"2020":155000,"2021":160000,"2022":165000,"2023":170000,"2024":175000},
    ],
    "ì»¤í”¼ìŒë£Œ": [
        {"brand":"ë§¥ì‹¬T.O.P","2019":520000,"2020":550000,"2021":580000,"2022":610000,"2023":650000,"2024":690000},
        {"brand":"ìŠ¤íƒ€ë²…ìŠ¤RTD","2019":280000,"2020":320000,"2021":370000,"2022":420000,"2023":480000,"2024":540000},
        {"brand":"ì¡°ì§€ì•„","2019":380000,"2020":400000,"2021":420000,"2022":440000,"2023":460000,"2024":480000},
        {"brand":"ì¹¸íƒ€íƒ€","2019":310000,"2020":320000,"2021":330000,"2022":340000,"2023":350000,"2024":360000},
        {"brand":"ë ˆì“°ë¹„","2019":250000,"2020":240000,"2021":230000,"2022":220000,"2023":210000,"2024":200000},
    ],
    "ì—ë„ˆì§€ìŒë£Œ": [
        {"brand":"ë ˆë“œë¶ˆ","2019":120000,"2020":140000,"2021":180000,"2022":220000,"2023":270000,"2024":320000},
        {"brand":"ëª¬ìŠ¤í„°","2019":95000,"2020":120000,"2021":160000,"2022":200000,"2023":250000,"2024":300000},
        {"brand":"í•«ì‹ìŠ¤","2019":85000,"2020":95000,"2021":110000,"2022":130000,"2023":150000,"2024":170000},
        {"brand":"ì…€ë ‰ìŠ¤","2019":30000,"2020":40000,"2021":55000,"2022":75000,"2023":100000,"2024":130000},
    ],
    "ìƒìˆ˜": [
        {"brand":"ì œì£¼ì‚¼ë‹¤ìˆ˜","2019":450000,"2020":500000,"2021":550000,"2022":610000,"2023":670000,"2024":720000},
        {"brand":"ì•„ì´ì‹œìŠ¤","2019":280000,"2020":300000,"2021":320000,"2022":350000,"2023":380000,"2024":410000},
        {"brand":"ë°±ì‚°ìˆ˜","2019":180000,"2020":200000,"2021":230000,"2022":260000,"2023":290000,"2024":320000},
    ],
    "ìœ ì‚°ê· ìŒë£Œ": [
        {"brand":"ì•¼ì¿ ë¥´íŠ¸","2019":280000,"2020":290000,"2021":300000,"2022":310000,"2023":320000,"2024":330000},
        {"brand":"ìœŒ","2019":150000,"2020":160000,"2021":175000,"2022":190000,"2023":200000,"2024":210000},
        {"brand":"ì¿ í¼ìŠ¤","2019":80000,"2020":90000,"2021":100000,"2022":110000,"2023":120000,"2024":130000},
    ],
}

PRODUCT_CARDS = {
    "ì½”ì¹´ì½œë¼": {"emoji":"ğŸ¥¤","desc":"ëŒ€í‘œ íƒ„ì‚°ìŒë£Œ, ë…ìì  ì›ì•¡ ë°°í•©","category":"íƒ„ì‚°ìŒë£Œ"},
    "í©ì‹œ": {"emoji":"ğŸ¥¤","desc":"ê¸€ë¡œë²Œ íƒ„ì‚°ìŒë£Œ, ì‹œíŠ¸ëŸ¬ìŠ¤ í’ë¯¸","category":"íƒ„ì‚°ìŒë£Œ"},
    "ì¹ ì„±ì‚¬ì´ë‹¤": {"emoji":"ğŸ«§","desc":"ë ˆëª¬ë¼ì„í–¥ ë¬´ì¹´í˜ì¸ íƒ„ì‚°ìŒë£Œ","category":"íƒ„ì‚°ìŒë£Œ"},
    "ë§¥ì‹¬T.O.P": {"emoji":"â˜•","desc":"í”„ë¦¬ë¯¸ì—„ RTD ì»¤í”¼, ì½œë“œë¸Œë£¨","category":"ì»¤í”¼ìŒë£Œ"},
    "ìŠ¤íƒ€ë²…ìŠ¤RTD": {"emoji":"â˜•","desc":"ìŠ¤íƒ€ë²…ìŠ¤ ì›ë‘ ì‚¬ìš© RTD","category":"ì»¤í”¼ìŒë£Œ"},
    "ë ˆë“œë¶ˆ": {"emoji":"âš¡","desc":"íƒ€ìš°ë¦°+ì¹´í˜ì¸ ì—ë„ˆì§€ìŒë£Œ","category":"ì—ë„ˆì§€ìŒë£Œ"},
    "ëª¬ìŠ¤í„°": {"emoji":"âš¡","desc":"ê³ ì¹´í˜ì¸ ì—ë„ˆì§€, ë‹¤ì–‘í•œ ë¼ì¸ì—…","category":"ì—ë„ˆì§€ìŒë£Œ"},
    "ì œì£¼ì‚¼ë‹¤ìˆ˜": {"emoji":"ğŸ’§","desc":"ì œì£¼ í™”ì‚°ì•”ë°˜ìˆ˜ ë¯¸ë„¤ë„ì›Œí„°","category":"ìƒìˆ˜"},
    "ì•¼ì¿ ë¥´íŠ¸": {"emoji":"ğŸ§«","desc":"ìœ ì‚°ê·  ë°œíš¨ìœ , ë½í† ë°”ì‹¤ëŸ¬ìŠ¤","category":"ìœ ì‚°ê· ìŒë£Œ"},
}

PROCESS_STEPS = [
    {"id":1,"name":"ì›ë£Œ ì…ê³ Â·ê²€ìˆ˜","icon":"ğŸ“¦","risk":"ì´ë¬¼ í˜¼ì…, ì„±ì ì„œ ë¯¸ë¹„","control":"ì…ê³ ê²€ì‚¬ SOP, COA í™•ì¸","level":"low"},
    {"id":2,"name":"ê³„ëŸ‰Â·ë°°í•©","icon":"âš–ï¸","risk":"ë°°í•© ì˜¤ì°¨, êµì°¨ì˜¤ì—¼","control":"ì „ìì €ìš¸ ìº˜ë¦¬ë¸Œë ˆì´ì…˜, ë°°í•©ì¼ì§€","level":"mid"},
    {"id":3,"name":"ìš©í•´Â·í˜¼í•©","icon":"ğŸ”„","risk":"ìš©í•´ ë¶ˆëŸ‰, ì˜¨ë„ ì´íƒˆ","control":"êµë°˜ì†ë„/ì˜¨ë„/ì‹œê°„ ëª¨ë‹ˆí„°ë§","level":"mid"},
    {"id":4,"name":"ê· ì§ˆí™”","icon":"ğŸ§ª","risk":"ì…ì ë¶ˆê· ì¼","control":"ê· ì§ˆì••ë ¥Â·íŒ¨ìŠ¤ íšŸìˆ˜ ì„¤ì •","level":"low"},
    {"id":5,"name":"ì‚´ê· ","icon":"ğŸ”¥","risk":"ì‚´ê·  ë¶€ì¡±/ê³¼ë„","control":"HTST 72Â°C/15s ë˜ëŠ” UHT 135Â°C/2s","level":"high"},
    {"id":6,"name":"ëƒ‰ê°","icon":"â„ï¸","risk":"ë¯¸ìƒë¬¼ ì¬ì˜¤ì—¼","control":"ë°€íì‹ ëƒ‰ê°, ì˜¨ë„ ê¸°ë¡","level":"mid"},
    {"id":7,"name":"ì¶©ì „Â·ë°€ë´‰","icon":"ğŸ«™","risk":"ìš©ê¸° ë¶ˆëŸ‰, ë°€ë´‰ ëˆ„ì„¤","control":"ì¶©ì „ëŸ‰ ê²€ì‚¬, ê¸°ë°€ì‹œí—˜","level":"high"},
    {"id":8,"name":"ê²€ì‚¬Â·ì¶œí•˜","icon":"âœ…","risk":"ë¶€ì í•© ì¶œí•˜","control":"ê´€ëŠ¥Â·ì´í™”í•™Â·ë¯¸ìƒë¬¼ ê²€ì‚¬","level":"low"},
]

SAMPLE_FORMULATIONS = {
    "íƒ„ì‚°ìŒë£Œ ê¸°ë³¸í˜•": "ì›ë£Œëª…,í•¨ëŸ‰(g),ë¹„ìœ¨(%),ê¸°ëŠ¥,ë“±ê¸‰\nì •ì œìˆ˜,430,86.0,ìš©ë§¤,ì‹í’ˆìš©ìˆ˜\nê³¼ë‹¹í¬ë„ë‹¹ì•¡,55,11.0,ê°ë¯¸,ì‹í’ˆì²¨ê°€ë¬¼\nêµ¬ì—°ì‚°,2.5,0.5,ì‚°ë¯¸ì¡°ì ˆ,ì‹í’ˆì²¨ê°€ë¬¼\níƒ„ì‚°ê°€ìŠ¤(CO2),4.0,0.8,íƒ„ì‚°,ì‹í’ˆì²¨ê°€ë¬¼\nì²œì—°í–¥ë£Œ,1.5,0.3,í’ë¯¸,ì²œì—°í–¥ë£Œ\nì¹´ë¼ë©œìƒ‰ì†Œ,0.8,0.16,ì°©ìƒ‰,ì‹í’ˆì²¨ê°€ë¬¼",
    "ì—ë„ˆì§€ìŒë£Œí˜•": "ì›ë£Œëª…,í•¨ëŸ‰(g),ë¹„ìœ¨(%),ê¸°ëŠ¥,ë“±ê¸‰\nì •ì œìˆ˜,410,82.0,ìš©ë§¤,ì‹í’ˆìš©ìˆ˜\nê³¼ë‹¹í¬ë„ë‹¹ì•¡,52,10.4,ê°ë¯¸,ì‹í’ˆì²¨ê°€ë¬¼\níƒ€ìš°ë¦°,1.0,0.2,ê¸°ëŠ¥ì„±,ì‹í’ˆì²¨ê°€ë¬¼\nì¹´í˜ì¸,0.15,0.03,ê°ì„±,ì‹í’ˆì²¨ê°€ë¬¼\nêµ¬ì—°ì‚°,3.0,0.6,ì‚°ë¯¸ì¡°ì ˆ,ì‹í’ˆì²¨ê°€ë¬¼\níƒ„ì‚°ê°€ìŠ¤,3.5,0.7,íƒ„ì‚°,ì‹í’ˆì²¨ê°€ë¬¼\ní•©ì„±í–¥ë£Œ,1.2,0.24,í’ë¯¸,í•©ì„±í–¥ë£Œ",
    "ê³¼ì±„ìŒë£Œí˜•": "ì›ë£Œëª…,í•¨ëŸ‰(g),ë¹„ìœ¨(%),ê¸°ëŠ¥,ë“±ê¸‰\nì •ì œìˆ˜,300,60.0,ìš©ë§¤,ì‹í’ˆìš©ìˆ˜\nì˜¤ë Œì§€ë†ì¶•ê³¼ì¦™,100,20.0,ê³¼ì¦™,ì²œì—°ì›ë£Œ\nì‚¬ê³¼ë†ì¶•ê³¼ì¦™,50,10.0,ê³¼ì¦™,ì²œì—°ì›ë£Œ\nê³¼ë‹¹í¬ë„ë‹¹ì•¡,30,6.0,ê°ë¯¸,ì‹í’ˆì²¨ê°€ë¬¼\nêµ¬ì—°ì‚°,2.0,0.4,ì‚°ë¯¸ì¡°ì ˆ,ì‹í’ˆì²¨ê°€ë¬¼\në¹„íƒ€ë¯¼C,0.5,0.1,ì‚°í™”ë°©ì§€,ì‹í’ˆì²¨ê°€ë¬¼\ní™í‹´,1.5,0.3,ì•ˆì •ì œ,ì‹í’ˆì²¨ê°€ë¬¼",
    "ìœ ì‚°ê· ìŒë£Œí˜•": "ì›ë£Œëª…,í•¨ëŸ‰(g),ë¹„ìœ¨(%),ê¸°ëŠ¥,ë“±ê¸‰\níƒˆì§€ë¶„ìœ í™˜ì›ì•¡,350,70.0,ê¸°ì§ˆ,ì²œì—°ì›ë£Œ\ní¬ë„ë‹¹,50,10.0,ê°ë¯¸,ì‹í’ˆì²¨ê°€ë¬¼\nê³¼ë‹¹,30,6.0,ê°ë¯¸,ì‹í’ˆì²¨ê°€ë¬¼\nìœ ì‚°ê· ë°°ì–‘ì•¡,20,4.0,ë°œíš¨,ìƒê· ì œ\nêµ¬ì—°ì‚°,3.0,0.6,ì‚°ë¯¸ì¡°ì ˆ,ì‹í’ˆì²¨ê°€ë¬¼\ní™í‹´,2.0,0.4,ì•ˆì •,ì‹í’ˆì²¨ê°€ë¬¼\nì •ì œìˆ˜,44,8.8,ìš©ë§¤,ì‹í’ˆìš©ìˆ˜",
    "ì €ë‹¹ ìŠ¤íŒŒí´ë§í˜•": "ì›ë£Œëª…,í•¨ëŸ‰(g),ë¹„ìœ¨(%),ê¸°ëŠ¥,ë“±ê¸‰\nì •ì œìˆ˜,445,89.0,ìš©ë§¤,ì‹í’ˆìš©ìˆ˜\nì—ë¦¬ìŠ¤ë¦¬í†¨,8,1.6,ê°ë¯¸(ì €ë‹¹),ëŒ€ì²´ê°ë¯¸ë£Œ\nìˆ˜í¬ë„ë¡œìŠ¤,0.03,0.006,ê³ ê°ë¯¸,ëŒ€ì²´ê°ë¯¸ë£Œ\nêµ¬ì—°ì‚°,2.5,0.5,ì‚°ë¯¸ì¡°ì ˆ,ì‹í’ˆì²¨ê°€ë¬¼\níƒ„ì‚°ê°€ìŠ¤,4.0,0.8,íƒ„ì‚°,ì‹í’ˆì²¨ê°€ë¬¼\në ˆëª¬ë†ì¶•ê³¼ì¦™,3.0,0.6,í’ë¯¸,ì²œì—°ì›ë£Œ\në¹„íƒ€ë¯¼C,0.3,0.06,ì‚°í™”ë°©ì§€,ì‹í’ˆì²¨ê°€ë¬¼",
}

YEARS = ["2019","2020","2021","2022","2023","2024"]
COLORS = ["#0EA5E9","#F59E0B","#10B981","#EF4444","#8B5CF6","#EC4899","#14B8A6","#F97316","#6366F1","#84CC16"]


# â”â”â” ìœ í‹¸ë¦¬í‹° â”â”â”
def get_sorted_categories():
    """2024 ë§¤ì¶œ ë†’ì€ ìˆœìœ¼ë¡œ ì •ë ¬"""
    return sorted(SALES_DATA.keys(), key=lambda c: SALES_DATA[c]["2024"], reverse=True)

def parse_csv_formula(text):
    """CSV í…ìŠ¤íŠ¸ â†’ DataFrame íŒŒì‹±"""
    import io
    if not text.strip():
        return None, "ë¹ˆ ì…ë ¥"
    try:
        lines = text.strip().split("\n")
        if len(lines) < 2:
            return None, "ìµœì†Œ í—¤ë”+1í–‰ í•„ìš”"
        df = pd.read_csv(io.StringIO(text))
        # ì»¬ëŸ¼ í‘œì¤€í™”
        col_map = {}
        for c in df.columns:
            cl = c.strip().lower()
            if "ì›ë£Œ" in cl or "name" in cl: col_map[c] = "ì›ë£Œëª…"
            elif "í•¨ëŸ‰" in cl or "amount" in cl: col_map[c] = "í•¨ëŸ‰"
            elif "ë¹„ìœ¨" in cl or "%" in cl or "pct" in cl: col_map[c] = "ë¹„ìœ¨(%)"
            elif "ê¸°ëŠ¥" in cl or "func" in cl: col_map[c] = "ê¸°ëŠ¥"
            elif "ë“±ê¸‰" in cl or "grade" in cl: col_map[c] = "ë“±ê¸‰"
        df = df.rename(columns=col_map)
        if "ì›ë£Œëª…" not in df.columns:
            return None, "'ì›ë£Œëª…' ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
        if "ë¹„ìœ¨(%)" in df.columns:
            df["ë¹„ìœ¨(%)"] = pd.to_numeric(df["ë¹„ìœ¨(%)"], errors="coerce").fillna(0)
        return df, "OK"
    except Exception as e:
        return None, str(e)

def validate_formula(df, meta=None):
    """ë°°í•©ë¹„ ê²€ì¦"""
    issues, warnings = [], []
    if "ë¹„ìœ¨(%)" in df.columns:
        total = df["ë¹„ìœ¨(%)"].sum()
        if total < 99:
            issues.append(f"ë¹„ìœ¨ í•©ê³„ {total:.1f}% â€” 100%ì— ë¯¸ë‹¬ ({100-total:.1f}% ë¶€ì¡±)")
        elif total > 101:
            issues.append(f"ë¹„ìœ¨ í•©ê³„ {total:.1f}% â€” 100% ì´ˆê³¼")
        else:
            warnings.append(f"ë¹„ìœ¨ í•©ê³„ {total:.1f}% âœ“")
    
    names = df["ì›ë£Œëª…"].str.lower().tolist() if "ì›ë£Œëª…" in df.columns else []
    if not any("ì •ì œìˆ˜" in n or "ë¬¼" in n for n in names):
        warnings.append("ì •ì œìˆ˜(ì‹í’ˆìš©ìˆ˜)ê°€ ì—†ìŠµë‹ˆë‹¤")
    if "ê¸°ëŠ¥" in df.columns:
        funcs = df["ê¸°ëŠ¥"].str.lower().fillna("").tolist()
        if not any("ê°ë¯¸" in f for f in funcs):
            warnings.append("ê°ë¯¸ë£Œê°€ ì—†ìŠµë‹ˆë‹¤")
        if not any("ì‚°ë¯¸" in f for f in funcs):
            warnings.append("ì‚°ë¯¸ë£Œê°€ ì—†ìŠµë‹ˆë‹¤")
    if len(df) < 3:
        issues.append("ì›ë£Œ 3ì¢… ë¯¸ë§Œ")
    
    if meta:
        brix = meta.get("brix")
        if brix and (brix < 1 or brix > 70):
            issues.append(f"Brix {brix}Â° â€” ë²”ìœ„(1~70Â°) ë²—ì–´ë‚¨")
        pH = meta.get("pH")
        if pH and (pH < 2 or pH > 8):
            issues.append(f"pH {pH} â€” ë²”ìœ„(2~8) ë²—ì–´ë‚¨")
    
    return {"issues": issues, "warnings": warnings, "passed": len(issues) == 0}

def save_formula(name, df, meta, student_name="default"):
    """ë°°í•©ë¹„ë¥¼ JSONìœ¼ë¡œ ì €ì¥"""
    filepath = os.path.join(SAVE_DIR, f"{student_name}_{name}_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json")
    data = {
        "name": name,
        "student": student_name,
        "meta": meta,
        "ingredients": df.to_dict(orient="records"),
        "timestamp": datetime.now().isoformat(),
    }
    with open(filepath, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=2)
    return filepath

def load_saved_formulas():
    """ì €ì¥ëœ ë°°í•©ë¹„ ëª©ë¡"""
    results = []
    for fn in sorted(os.listdir(SAVE_DIR), reverse=True):
        if fn.endswith(".json"):
            try:
                with open(os.path.join(SAVE_DIR, fn), "r", encoding="utf-8") as f:
                    data = json.load(f)
                data["filename"] = fn
                results.append(data)
            except:
                pass
    return results
